<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/bootstrap-3.4.1-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/customerDashboard.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobcare - Dashboard</title>
</head>
<body>
    <nav>
        <h3 style="font-weight: bolder;">Mobcare</h3>
        <aside>
            <img src="https://res.cloudinary.com/dbfue99qr/image/upload/v1707734165/Mobcare/3135715_xvqxwa.png" alt="avater">
            <span style="color: white;" class=" glyphicon glyphicon-option-horizontal" onclick="showMenu()">
            <ul class="menu">
                <li><a href="/" style="color: white;">Home</a></li>
            </ul>
            </span>
        </aside>
    </nav>

     <!-- Fund wallet pop up modal -->
     <section class="popUp">
        <b style="text-align: right; margin-left: 78%;" class="back" onclick="hidePopUp(popUp)"><i class="glyphicon glyphicon-chevron-left"></i> Back</b>
        <div class="popUpBox">
            <p class="message">
                
                <h2 style="color: #046599; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);">Fund Wallet</h2>
                <ul>
                  <li >Account Number: </li>
                  <li style="color: #046599; margin-bottom: .4rem; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3)"><b id="acctNo"><%= accountNumber %></b></li>
                  <li  >Name: </li>
                  <li style="color: #046599;  margin-bottom: .4rem; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3)"><b><%= firstName %> <%= lastName %></b></li>
                  <li  >Bank:</li>
                  <li style="color: #046599;  margin-bottom: .4rem; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3)"><b>Hope PSB</b></li>
                </ul>

                <button class="completeBtn btn btn-success" onclick="fundWalletReq()">Complete Payment</button>
                <br>

                <b style="color: rgb(83, 75, 75);">Instruction:</b>
                <br>
                <span style="color: rgb(83, 75, 75);">
                    Make a transfer of the amount you want to fund your wallet with into the above account, then return to this page and click the <b>"Complete Payment"</b>
                    button. 
                    Note that you must click the <b>"Complete Payment"</b> button for your transfer to reflect in your wallet balance.
                </span>
            </p>
        </div>
    </section>

    <!-- request claim pop up modal -->
    <section class="popUp" id="RC-popUp">
        <b style="text-align: right; margin-left: 78%;" class="back" onclick="hidePopUp(RC_popUp)"><i class="glyphicon glyphicon-chevron-left"></i> Back</b>
        <div class="popUpBox">
            <p class="message">
                <h2 style="color: #046599; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);">Request Claim</h2>
                <ul>
                  <li ><b id="reqClaimDisplay">Are you sure you want to request for a claim?</b></li>
                </ul>

                <div class="RC-popUp-buttons">
                    <button class="btn btn-success" id="sendClaimReq" onclick="sendClaimRe()">Yes</button>
                    <button class="btn btn-danger" onclick="hidePopUp(RC_popUp)">Cancel</button>
                </div>
                <br>

                <b style="color: rgb(83, 75, 75);">Notice:</b>
                <br>
                <span style="color: rgb(83, 75, 75);">
                   Your claim request will be sent and we will response to you with an appointment date to take your device to our office.
                   Check your appointments in your dashboard to see your appointment date.
                </span>
            </p>
        </div>
    </section>

    <!-- modal for subscriptions -->
    <section class="popUp" id="subscriptionModal">
    <b style="text-align: right; margin-left: 78%;" class="back" onclick="hidePopUp(subscriptionModal)"><i class="glyphicon glyphicon-chevron-left"></i> Back</b>
    <div class="popUpBox" id="sub-modal">
        <h2>Paid Subscriptions</h2>
        <% if (typeof repairPlanResult === 'undefined') { %>
            <p></p>
        <% } else { %>
            <h4 style="text-align: center; font-weight: bold;"><b>Repair Plan</b></h4>
            <div class="tableCont">
                <table class="table table-striped">
                    <thead>
                        <tr class="bg bg-primary">
                            <th>Month</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                            <tr>
                                <td>January</td>
                                <td><%= repairPlanResult.January %></td>
                            </tr>
                            <tr>
                                <td>February</td>
                                <td><%= repairPlanResult.February %></td>
                            </tr>
                            <tr>
                                <td>March</td>
                                <td><%= repairPlanResult.March %></td>
                            </tr>
                            <tr>
                                <td>April</td>
                                <td><%= repairPlanResult.April %></td>
                            </tr>
                            <tr>
                                <td>May</td>
                                <td><%= repairPlanResult.May %></td>
                            </tr>
                            <tr>
                                <td>June</td>
                                <td><%= repairPlanResult.June %></td>
                            </tr>
                    </tbody>
                </table>

                <table class="table table-striped">
                    <thead>
                        <tr class="bg bg-primary">
                            <th>Month</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                            <tr>
                                <td>July</td>
                                <td><%= repairPlanResult.July %></td>
                            </tr>
                            <tr>
                                <td>August</td>
                                <td><%= repairPlanResult.August %></td>
                            </tr>
                            <tr>
                                <td>September</td>
                                <td><%= repairPlanResult.September %></td>
                            </tr>
                            <tr>
                                <td>October</td>
                                <td><%= repairPlanResult.October %></td>
                            </tr>
                            <tr>
                                <td>November</td>
                                <td><%= repairPlanResult.November %></td>
                            </tr>
                            <tr>
                                <td>December</td>
                                <td><%= repairPlanResult.December %></td>
                            </tr>
                    </tbody>
                </table>
            </div>
        <% } %>

        <% if (typeof theftPlanResult === 'undefined') { %>
            <p></p>
        <% } else { %>
            <h4 style="text-align: center; font-weight: bold;"><b>Theft Plan</b></h4>
            <div class="tableCont">
                <table class="table table-striped">
                    <thead>
                        <tr class="bg bg-primary">
                            <th>Month</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                            <tr>
                                <td>January</td>
                                <td><%= theftPlanResult.January %></td>
                            </tr>
                            <tr>
                                <td>February</td>
                                <td><%= theftPlanResult.February %></td>
                            </tr>
                            <tr>
                                <td>March</td>
                                <td><%= theftPlanResult.March %></td>
                            </tr>
                            <tr>
                                <td>April</td>
                                <td><%= theftPlanResult.April %></td>
                            </tr>
                            <tr>
                                <td>May</td>
                                <td><%= theftPlanResult.May %></td>
                            </tr>
                            <tr>
                                <td>June</td>
                                <td><%= theftPlanResult.June %></td>
                            </tr>
                    </tbody>
                </table>

                <table class="table table-striped">
                    <thead>
                        <tr class="bg bg-primary">
                            <th>Month</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                            <tr>
                                <td>July</td>
                                <td><%= theftPlanResult.July %></td>
                            </tr>
                            <tr>
                                <td>August</td>
                                <td><%= theftPlanResult.August %></td>
                            </tr>
                            <tr>
                                <td>September</td>
                                <td><%= theftPlanResult.September %></td>
                            </tr>
                            <tr>
                                <td>October</td>
                                <td><%= theftPlanResult.October %></td>
                            </tr>
                            <tr>
                                <td>November</td>
                                <td><%= theftPlanResult.November %></td>
                            </tr>
                            <tr>
                                <td>December</td>
                                <td><%= theftPlanResult.December %></td>
                            </tr>
                    </tbody>
                </table>
            </div>
        <% } %>
        

        <% if (typeof purchasePlanResult === 'undefined') { %>
            <p></p>
        <% } else { %>
            <h4 style="text-align: center; font-weight: bold;"><b>Purchase Plan</b></h4>
            <div class="tableCont">
                <table class="table table-striped">
                    <thead>
                        <tr class="bg bg-primary">
                            <th>Month</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                            <tr>
                                <td>January</td>
                                <td><%= purchasePlanResult.January %></td>
                            </tr>
                            <tr>
                                <td>February</td>
                                <td><%= purchasePlanResult.February %></td>
                            </tr>
                            <tr>
                                <td>March</td>
                                <td><%= purchasePlanResult.March %></td>
                            </tr>
                            <tr>
                                <td>April</td>
                                <td><%= purchasePlanResult.April %></td>
                            </tr>
                            <tr>
                                <td>May</td>
                                <td><%= purchasePlanResult.May %></td>
                            </tr>
                            <tr>
                                <td>June</td>
                                <td><%= purchasePlanResult.June %></td>
                            </tr>
                    </tbody>
                </table>

                <table class="table table-striped">
                    <thead>
                        <tr class="bg bg-primary">
                            <th>Month</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                            <tr>
                                <td>July</td>
                                <td><%= purchasePlanResult.July %></td>
                            </tr>
                            <tr>
                                <td>August</td>
                                <td><%= purchasePlanResult.August %></td>
                            </tr>
                            <tr>
                                <td>September</td>
                                <td><%= purchasePlanResult.September %></td>
                            </tr>
                            <tr>
                                <td>October</td>
                                <td><%= purchasePlanResult.October %></td>
                            </tr>
                            <tr>
                                <td>November</td>
                                <td><%= purchasePlanResult.November %></td>
                            </tr>
                            <tr>
                                <td>December</td>
                                <td><%= purchasePlanResult.December %></td>
                            </tr>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>
</section>

    <!-- placeholder for phone number -->
    <p class="phone" style="display: none;"><%= phoneNumber %></p>

    

    <section class="boxCont">
        <div class="box">
            <img src="https://res.cloudinary.com/dbfue99qr/image/upload/v1707734165/Mobcare/wallet_c8come.png" alt="">
           <h3>Welcome back!</h3>
           <h1><%= firstName %></h1>
           <div class="balance">
            <p>Balance:</p>
            <p>&#8358; <%= balance %></p>
           </div>
        </div>
        
        <div class="box">
            
            <p style="text-align: center; font-size: .8em; color: #046599; " ><span class="glyphicon glyphicon-list"></span></p>
                      
        <% if (numberOfPlans == 1) { %>
                <div class="planText">
                    <div>
                        <p>Subscribed Plan:</p>
                        <b class="currentPlan"><%= plan1 %></b>
                    </div>
                    
                    <div>
                        <!-- Add Plan + button with custom tooltip -->
                        <button type="button"  id="addPlanBtn">Add Plan +</button>
                        <div id="tooltip" class="hidden">Add a new plan</div>
                    </div>
                </div>
        <% } else { %>
                <div class="planText" style="align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <p style="margin: .5rem;">Subscribed Plans:</p>
                        <b class="currentPlan" style="margin: .5rem;"><%= plan1 %></b>
                        <br>
                        <b class="currentPlan" style="margin: .5rem;"><%= plan2 %></b>
                    </div>
                </div>
        <% } %>
           
           
            
           
        </div>
        <div class="box" id="fundWallet" onclick="showPopUp(popUp)">
            <img src="https://res.cloudinary.com/dbfue99qr/image/upload/v1707734165/Mobcare/wallet_c8come.png" alt="">
            <h2>Fund Wallet</h2>
        </div>
        <div class="box others" onclick="showPopUp(RC_popUp)">
            <p> <span class="glyphicon glyphicon-edit"></span></p>
            <h2>Request Claim</h2>
        </div>
        <div class="box others">
            <p> <span class="glyphicon glyphicon-calendar"></span></p>
            <h2>Appointments</h2>
            <p style="text-align: center;"> <%= message %> </p>
        </div>
        <div class="box others" onclick="showPopUp(subscriptionModal)">
            <p> <span class="glyphicon glyphicon-check"></span></p>
            <h2>Subscriptions</h2>
        </div>
    </section>
    <script src="css/bootstrap-3.4.1-dist/js/npm.js"></script>
    <script>
        // Get the button and tooltip elements
        const addPlanBtn = document.getElementById('addPlanBtn');
        const tooltip = document.getElementById('tooltip');
        const currentPlan = document.querySelector('.currentPlan')
        const back = document.querySelector('.back')
        const popUp = document.querySelector('.popUp')
        const fundWallet = document.getElementById('fundWallet');
        const RC_popUp = document.getElementById('RC-popUp');
        const sendClaimReq = document.getElementById('sendClaimReq');
        const phone = document.querySelector('.phone').innerText;
        const subscriptionModal = document.getElementById('subscriptionModal')



        //logic to show menu
        function showMenu() {
            var menu = document.querySelector('.menu')
            menu.classList.toggle('showMenu')
        }
        
        //logic to input icons in table
        function inputIcon() {
            var trElements = document.getElementsByTagName("tr");
            // Loop through each <tr> element
            for (var i = 0; i < trElements.length; i++) {
                // Get the second child element of each <tr> (index 1)
                var statusField = trElements[i].children[1].innerHTML.trim();
                if (statusField === 'Enabled') {
                    statusField = `<span class="glyphicon glyphicon-ok"  style="color: green;"></span>`;
                } else if (statusField === 'Disabled') {
                    statusField = `<span class="glyphicon glyphicon-remove" style="color: red;"></span>`;
                }
                // Set the innerHTML of the second child element
                trElements[i].children[1].innerHTML = statusField;
            }
        }
        inputIcon();


        

        //add plan logic
        tooltip.addEventListener('click', function () {
            
            var data = {acctNo: phone,
                        planToAdd: this.innerText
                    }

            var fetchOptions = {
                method: 'POST',
                headers: new Headers({
                    'Content-Type': 'application/json; charset=UTF-8'
                }),
                body: JSON.stringify(data)
            }

            fetch('/add-plan', fetchOptions)
            .then(res => {
                if (res.ok) console.log('successful')
                tooltip.innerText = 'Plan Added!'
                setTimeout(()=> {
                    tooltip.style.display = 'none'
                }, 3000)
            })
            .catch(err => {
                console.error('Error: ', err)
            })
        })

        // Show tooltip when button is clicked
        addPlanBtn.addEventListener('click', () => {
            var plan = currentPlan.innerHTML
            if (plan == 'Theft') {
                tooltip.innerText = 'Repair'
            } else {
                tooltip.innerText = 'Theft'
            }
            tooltip.classList.toggle('hidden');
        });

        function showPopUp(param) {
            param.style.zIndex = 2;
            param.style.opacity = 1
        }

        function hidePopUp(param) {
            param.style.zIndex = -4;
            param.style.opacity = 0
        }


        function sendClaimRe() {
            var sendClaimReqBtn = document.getElementById('sendClaimReq')
            sendClaimReqBtn.disabled = true;
            sendClaimReqBtn.innerHTML = 'Sending...'
            var reqClaimDisplay = document.getElementById('reqClaimDisplay')
            
            var data = {
                phone: phone // Corrected to use the variable value
            };

            fetch('/request-claim', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: new Headers({
                    'Content-Type': 'application/json; charset=UTF-8'
                })
            })
            .then(res => {
                if (res.ok) {
                    sendClaimReqBtn.disabled = false;
                    reqClaimDisplay.innerText = 'Your Claim request has been sent. Please wait for your appointment date.'
                    sendClaimReqBtn.innerHTML = 'Done'
                    console.log('Request successful'); // Request was successful
                } else {
                    reqClaimDisplay.innerText = 'Your Claim request was not sent. Please wait reload your dashboard and try again.'
                    sendClaimReqBtn.innerHTML = 'Failed'
                    console.error('Request failed:', res.statusText); // Request failed
                }
            })
            .catch(err => {
                console.error(err);
            });
        }


        //logic for creating local storage
        // function createCache() {
        //     const acctNo = document.getElementById('acctNo').innerText;
        //     localStorage.setItem('acctId', acctNo)
        // }
        // createCache();
        
        //LOGIC FOR FUND WALLET
        function fundWalletReq() {
            const acctNo = document.getElementById('acctNo').innerText;
            var completeBtn = document.querySelector('.completeBtn')
            var data = {acctNo: acctNo,
                        phone: phone
            }
            completeBtn.disabled = true
            completeBtn.innerHTML = 'Please Wait...'
            var fetchOptions = {
                method: 'POST',
                headers: new Headers({
                    'Content-Type': 'application/json; charset=UTF-8'
                }),
                body: JSON.stringify(data)
            }

            fetch('/fund-wallet', fetchOptions)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    completeBtn.innerHTML = 'Payment Failed';
                }
            })
            .then(data => {
                completeBtn.disabled = false;
                completeBtn.innerHTML = data.message;
                alert('Payment Successful')
            })
            .catch(err => {
                console.error('Error: ', err)
                completeBtn.innerHTML = "Payment Failed";
            })
        }

        //LOGIC TO RENEW PLAN
        var showRenew = document.querySelector('.showRenew')
        var renew = document.querySelector('.renew')
        showRenew.addEventListener('click', function () {
            renew.classList.toggle('showRenewBtn')
        })

        renew.addEventListener('click', function () {
          var lastMonthPaid = showRenew.innerText;
          var data = {
                lastMonthPaid: lastMonthPaid,
                 phone: phone   
            }
          var options = {
            method: 'POST',
            headers: new Headers({
                    'Content-Type': 'application/json; charset=UTF-8'
                }),
                body: JSON.stringify(data)
          }
          fetch('/renew-subscription', options)
        })
    </script>
</body>
</html>
